from fastapi import FastAPI, Form, UploadFile, File, Request
from typing import Optional
from pydantic import BaseModel
import json

class ChatRequest(BaseModel):
    session_id: str
    message: str

# Option 1: Two separate endpoints (recommended for clarity)
@app.post("/chat")
async def chat_handler(request: Request):
    content_type = request.headers.get("content-type", "")
    
    if "multipart/form-data" in content_type:
        # Handle FormData with images
        form = await request.form()
        session_id = form.get("session_id")
        message = form.get("message")
        images: list[UploadFile] = form.getlist("images")
        
        # Process images - read bytes, convert to base64, etc.
        image_data = []
        for img in images:
            img_bytes = await img.read()
            image_data.append(img_bytes)
        
        # Pass to your LLM with images
        return await process_chat_with_images(session_id, message, image_data)
    else:
        # Handle JSON (text-only)
        body = await request.json()
        session_id = body.get("session_id")
        message = body.get("message")
        
        # Pass to your LLM without images
        return await process_chat(session_id, message)
